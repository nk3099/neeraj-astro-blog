---
import BaseLayout from "../../layouts/BaseLayout.astro";
import DashedComponent from "../../components/DashedComponent.astro";

// Fetching all posts and generating unique tags dynamically
export async function getStaticPaths() {
  const allPosts = Object.values(
    import.meta.glob("../posts/*.md", { eager: true }),
  );

  // Extract unique tags from the posts
  const uniqueTags = [
    ...new Set(allPosts.map((post: any) => post.frontmatter.tags).flat()),
  ];

  // Generate paths for each tag with associated posts
  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post: any) =>
      post.frontmatter.tags.includes(tag),
    );

    // Sort posts by published date (descending)
    filteredPosts.sort((a: any, b: any) =>
      new Date(b.frontmatter.publishedDate).getTime() -
      new Date(a.frontmatter.publishedDate).getTime()
    );

    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

// Extract the current tag and posts from props
const { tag } = Astro.params;
const { posts } = Astro.props;

// Page title and description
const title ="Neeraj Kumar";
const description = `Posts tagged with "${tag}"`;
---

<BaseLayout {title} {description}>
  <div class="flex items-center gap-2 mb-2">
    <h1 class="text-3xl font-bold">üè∑Ô∏è Tag: </h1>
    <span class="text-3xl font-bold font-mono text-blue-400">#{tag}</span>
  </div>
  <p class="italic text-zinc-500 mt-2 mb-6 text-lg">
    {posts.length} {posts.length === 1 ? "post" : "posts"} tagged with "{tag}"
  </p>
  <DashedComponent />

  <!-- Posts Section -->
  {posts.length === 0 ? (
    <div class="mt-8 text-center text-zinc-500">
      <p>No posts found for this tag.</p>
    </div>
  ) : (
    <ul class="mt-8">
      {posts.map((post: any) => (
        <li key={post.frontmatter.slug}>
          <div class="flex flex-row gap-6 text-lg items-baseline">
            <!-- Displaying the formatted published date with fixed width for alignment -->
            <p class="w-32 tabular-nums">
              {new Date(post.frontmatter.publishedDate).toLocaleDateString("en-us", {
                year: "numeric",
                month: "short",
                day: "2-digit",
              })}
            </p>
            <!-- Displaying the post title as a link -->
            <a
              href={post.url}
              class="text-lg text-blue-400 hover:text-blue-300 hover:underline"
              data-astro-prefetch
            >
              {post.frontmatter.title}
            </a>
          </div>
        </li>
      ))}
    </ul>
  )}

  <!-- Back to all tags link -->
  <div class="mt-12">
    <a
      href="/tags"
      class="text-blue-400 hover:text-blue-300 hover:underline flex items-center gap-2"
      data-astro-prefetch
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 19l-7-7m0 0l7-7m-7 7h18"
        />
      </svg>
      View all tags
    </a>
  </div>
</BaseLayout>
